# 프론트엔드 실시간 가상 피팅 연동 완료

## 🎯 구현 내용

"입어보기" 버튼을 클릭하면 **실시간 가상 피팅**이 시작됩니다!

---

## 🆕 추가된 기능

### 1. 실시간 가상 피팅 모드
- **시작/중지 토글**: 한 번 클릭으로 시작, 다시 클릭으로 중지
- **실시간 프레임 처리**: 200ms마다 프레임을 서버로 전송하여 처리
- **즉시 피드백**: 처리된 결과를 실시간으로 화면에 표시

### 2. 옷 이미지 업로드
- **"옷 선택" 버튼**: 가상 피팅에 사용할 옷 이미지 업로드
- **서버 저장**: `/api/fit/upload-cloth` API로 전송
- **자동 배경 제거**: 서버에서 자동으로 배경 제거 후 사용

### 3. 시각적 피드백
- **피팅 모드 표시**: 화면 좌상단에 "🎽 가상 피팅 중..." 배지
- **상태바 업데이트**: "🎽 실시간 가상 피팅 활성화" 표시
- **버튼 상태 변경**: 
  - 비활성: 노란색 "입어보기"
  - 활성: 초록색 "피팅 중지"

---

## 🎮 사용 방법

### 1단계: 옷 이미지 준비 (선택)
```
1. "옷 선택" 버튼 클릭
2. 옷 이미지 파일 선택
3. 업로드 완료 알림 확인
```

**기본 옷**: 업로드하지 않으면 `input/cloth.jpg` 사용

### 2단계: 카메라 시작
```
자동으로 카메라가 시작됨
```

### 3단계: 가상 피팅 시작
```
1. "입어보기" 버튼 클릭 (노란색)
2. 버튼이 초록색 "피팅 중지"로 변경
3. 실시간으로 옷이 오버레이됨
```

### 4단계: 피팅 중지
```
1. "피팅 중지" 버튼 클릭 (초록색)
2. 일반 카메라 모드로 복귀
```

---

## 🔄 동작 흐름

```
사용자: "입어보기" 버튼 클릭
    ↓
프론트: 가상 피팅 모드 활성화
    ↓
프론트: 200ms마다 프레임 캡처
    ↓
프론트: Base64로 인코딩
    ↓
프론트: POST /api/fit/stream
    ↓
백엔드: 프레임 디코딩
    ↓
백엔드: MediaPipe 포즈 추적
    ↓
백엔드: 옷 관절 매칭 및 변형
    ↓
백엔드: 옷 오버레이
    ↓
백엔드: 처리된 프레임 반환
    ↓
프론트: 화면에 표시
    ↓
(반복)
```

---

## 🎨 UI 구성

### 비디오 영역
```
┌─────────────────────────┐
│ 🎽 가상 피팅 중...      │ ← 피팅 모드 배지
│                         │
│                         │
│   [실시간 영상/피팅]    │
│                         │
│                         │
│                         │
└─────────────────────────┘
│ 🎽 실시간 가상 피팅 활성화 │ ← 상태바
└─────────────────────────┘
```

### 버튼 영역
```
┌──────────┬──────────┬──────────┬────────┐
│ 질문하기 │ 옷저장   │ 옷 선택   │ 입어보기 │
│          │          │ (NEW)   │ (변경) │
└──────────┴──────────┴──────────┴────────┘
```

**버튼 상태:**
- 옷 선택: 파란색 (info)
- 입어보기: 노란색 → 초록색 (warning → success)

---

## 📡 API 통신

### 옷 이미지 업로드
```javascript
POST /api/fit/upload-cloth
{
    "image": "data:image/jpeg;base64,..."
}

Response:
{
    "success": true,
    "message": "옷 이미지 업로드 완료",
    "path": "C:\\...\\cloth.jpg"
}
```

### 실시간 프레임 처리
```javascript
POST /api/fit/stream
{
    "frame": "data:image/jpeg;base64,...",
    "showSkeleton": true,
    "useWarp": true
}

Response:
{
    "success": true,
    "frame": "data:image/jpeg;base64,..."
}
```

---

## ⚙️ 주요 설정

### 프레임 전송 주기
```javascript
fittingIntervalRef.current = setInterval(() => {
    sendFittingFrame();
}, 200);  // 200ms = 5 FPS
```

**조정 가능:**
- 100ms: 10 FPS (더 부드럽지만 서버 부하 증가)
- 200ms: 5 FPS (권장)
- 500ms: 2 FPS (느리지만 부하 적음)

### JPEG 품질
```javascript
const frameData = canvas.toDataURL("image/jpeg", 0.8);
```

**품질 설정:**
- 0.5: 낮은 품질, 빠른 전송
- 0.8: 권장 (균형)
- 1.0: 최고 품질, 느린 전송

---

## 🎯 상태 관리

### React State
```javascript
const [isFittingMode, setIsFittingMode] = useState(false);
// 가상 피팅 모드 활성화 여부

const [fittingFrame, setFittingFrame] = useState(null);
// 서버에서 받은 처리된 프레임

const [showSkeleton, setShowSkeleton] = useState(true);
// 스켈레톤 표시 여부 (향후 토글 기능 추가 가능)

const [useWarp, setUseWarp] = useState(true);
// 관절 매칭 변형 사용 (향후 토글 기능 추가 가능)
```

### Refs
```javascript
const fittingIntervalRef = useRef(null);
// 프레임 전송 인터벌 ID

const clothFileInputRef = useRef(null);
// 옷 파일 입력 참조
```

---

## 🐛 에러 처리

### 프레임 처리 실패
```javascript
if (!response.ok) {
    console.error("[프론트] 피팅 프레임 처리 실패:", response.status);
    return;  // 조용히 실패 (다음 프레임 계속 시도)
}
```

### 옷 업로드 실패
```javascript
catch (e) {
    console.error("[프론트] 옷 업로드 에러:", e);
    alert("옷 업로드 실패: " + e.message);
}
```

---

## 🎨 스타일링

### 피팅 모드 배지
```javascript
{
    position: "absolute",
    top: 10,
    left: 10,
    background: "rgba(0, 255, 0, 0.7)",
    color: "white",
    padding: "8px 16px",
    borderRadius: 8,
    fontWeight: "bold"
}
```

### 비디오 전환
```javascript
// 일반 모드: 비디오 표시
display: isFittingMode ? "none" : "block"

// 피팅 모드: 처리된 이미지 표시
{isFittingMode && fittingFrame && (
    <img src={fittingFrame} ... />
)}
```

---

## 🚀 성능 최적화

### 1. 프레임 전송 최적화
```javascript
// 이미지 품질 조정
canvas.toDataURL("image/jpeg", 0.8)  // 80% 품질

// 전송 주기 조정
setInterval(sendFittingFrame, 200)  // 200ms 간격
```

### 2. 에러 복구
```javascript
catch (error) {
    console.error(error);
    // 계속 진행 (다음 프레임에서 재시도)
}
```

### 3. 리소스 정리
```javascript
useEffect(() => {
    return () => {
        if (fittingIntervalRef.current) {
            clearInterval(fittingIntervalRef.current);
        }
    };
}, []);
```

---

## 📝 사용 시나리오

### 시나리오 1: 기본 옷으로 피팅
```
1. "입어보기" 버튼 클릭
2. 기본 옷(input/cloth.jpg)으로 피팅 시작
3. 실시간으로 옷이 입혀짐
4. "피팅 중지"로 종료
```

### 시나리오 2: 커스텀 옷으로 피팅
```
1. "옷 선택" 버튼 클릭
2. 원하는 옷 이미지 업로드
3. "옷 이미지 업로드 완료" 알림 확인
4. "입어보기" 버튼 클릭
5. 업로드한 옷으로 피팅 시작
```

### 시나리오 3: 여러 옷 비교
```
1. 첫 번째 옷 업로드 → 입어보기
2. "피팅 중지"
3. 두 번째 옷 업로드 → 입어보기
4. 비교 완료
```

---

## ⚡ 향후 개선 가능 사항

### 1. UI 개선
- [ ] 스켈레톤 ON/OFF 토글 버튼
- [ ] 관절 매칭 모드 토글 버튼
- [ ] FPS 조정 슬라이더
- [ ] 품질 설정 옵션

### 2. 기능 추가
- [ ] 피팅 결과 스크린샷 저장
- [ ] 여러 옷 프리셋 저장
- [ ] 옷 색상 변경
- [ ] 확대/축소 기능

### 3. 성능 개선
- [ ] WebSocket 사용 (HTTP 대신)
- [ ] 프레임 압축
- [ ] 캐싱 전략
- [ ] GPU 가속

---

## ✅ 테스트 체크리스트

### 기본 기능
- [ ] 카메라가 자동으로 시작됨
- [ ] "입어보기" 버튼 클릭 시 피팅 시작
- [ ] 실시간으로 옷이 표시됨
- [ ] "피팅 중지" 버튼으로 종료 가능
- [ ] 상태바에 "가상 피팅 활성화" 표시

### 옷 업로드
- [ ] "옷 선택" 버튼으로 파일 선택 가능
- [ ] 업로드 성공 알림 표시
- [ ] 업로드한 옷이 피팅에 반영됨

### 에러 처리
- [ ] 서버 연결 실패 시 조용히 재시도
- [ ] 옷 업로드 실패 시 알림 표시
- [ ] 카메라 권한 없을 때 적절한 메시지

---

## 🎓 핵심 코드

### 가상 피팅 시작/중지
```javascript
const handleStartFit = () => {
    if (isFittingMode) {
        stopVirtualFitting();
    } else {
        startVirtualFitting();
    }
};
```

### 프레임 전송
```javascript
const sendFittingFrame = async () => {
    // 캔버스에 비디오 프레임 그리기
    ctx.drawImage(video, 0, 0, w, h);
    
    // Base64 인코딩
    const frameData = canvas.toDataURL("image/jpeg", 0.8);
    
    // 서버로 전송
    const response = await fetch("/api/fit/stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            frame: frameData,
            showSkeleton: true,
            useWarp: true
        })
    });
    
    // 결과 표시
    const result = await response.json();
    setFittingFrame(result.frame);
};
```

---

이제 프론트엔드에서 "입어보기" 버튼만 클릭하면 실시간 가상 피팅이 시작됩니다! 🎉
