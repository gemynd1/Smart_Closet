# 실시간 가상 피팅 시스템 구현 완료

## 📌 개요
캡처된 사진이 아닌 **실시간 비디오 스트림**으로 가상 피팅을 구현했습니다.
- 실시간 포즈 추적 (MediaPipe)
- 옷 배경 자동 제거
- 관절 위치 기반 옷 오버레이
- 프론트엔드 실시간 표시

---

## 🗂️ 새로 생성된 파일

### 1. `back/fit/cloth_processor.py`
옷 이미지 처리 모듈
- **remove_background()**: 옷 배경을 투명하게 제거 (rembg 사용)
- **resize_cloth_to_body()**: 신체 크기에 맞게 옷 리사이즈
- **overlay_cloth_on_body()**: 프레임에 옷 오버레이 (알파 블렌딩)

### 2. `back/fit/virtual_fitting.py`
실시간 가상 피팅 메인 로직
- **VirtualFitting 클래스**: 실시간 처리 담당
- **calculate_body_metrics()**: 어깨 너비, 상체 높이 계산
- **process_frame()**: 각 프레임마다 옷 입히기
- **run_webcam()**: 독립 실행 가능 (테스트용)

### 3. `back/routes/clothes.py` (추가)
실시간 API 엔드포인트
- **POST /api/fit/stream**: 프레임 받아서 처리 후 반환
- **POST /api/fit/upload-cloth**: 옷 이미지 업로드

---

## 🔧 필수 패키지 설치

### 백엔드 Python 패키지
```powershell
# 가상환경 활성화
.venv312\Scripts\Activate.ps1

# 패키지 설치
pip install rembg
pip install mediapipe
pip install opencv-python
pip install pillow
```

---

## 🎯 동작 원리

### 1단계: 옷 이미지 준비
```
input/cloth.jpg (옷 사진)
    ↓
배경 제거 (rembg)
    ↓
output/cloth_nobg.png (투명 배경)
```

### 2단계: 실시간 포즈 추적
```
웹캠 프레임
    ↓
MediaPipe Pose 감지
    ↓
33개 랜드마크 추출
    ↓
어깨 중심, 너비, 상체 높이 계산
```

### 3단계: 옷 오버레이
```
신체 치수 계산
    ↓
옷 이미지 리사이즈
    ↓
어깨 중심 위치에 배치
    ↓
알파 블렌딩으로 자연스럽게 합성
    ↓
스켈레톤 그리기 (선택)
```

---

## 📡 API 사용법

### 1. 옷 이미지 업로드
```javascript
const response = await fetch('/api/fit/upload-cloth', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        image: base64ImageData  // 옷 이미지 (Base64)
    })
});
```

### 2. 실시간 프레임 처리
```javascript
const response = await fetch('/api/fit/stream', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        frame: base64FrameData,  // 비디오 프레임 (Base64)
        showSkeleton: true       // 스켈레톤 표시 여부
    })
});

const result = await response.json();
// result.frame: 처리된 프레임 (Base64)
```

---

## 🖥️ 독립 실행 (테스트용)

웹 없이 바로 실행 가능:
```powershell
cd C:\Users\parkj\Desktop\Smart_Closet\back\fit
python virtual_fitting.py
```

**키 조작:**
- `s`: 스켈레톤 ON/OFF
- `q`: 종료

---

## 📁 파일 구조

```
back/fit/
├── input/
│   ├── cloth.jpg           # 옷 원본 이미지
│   └── model.jpg          # (이전 방식용)
├── output/
│   └── cloth_nobg.png     # 배경 제거된 옷 이미지 (자동 생성)
├── cloth_mask.py          # 상반신 마스크 생성 (기존)
├── cloth_processor.py     # 옷 처리 모듈 (신규)
├── virtual_fitting.py     # 가상 피팅 메인 (신규)
└── main.py               # 이전 방식 (정적 이미지)
```

---

## 🎨 주요 파라미터

### VirtualFitting 클래스
```python
VirtualFitting(
    cloth_image_path='input/cloth.jpg'  # 옷 이미지 경로
)
```

### process_frame() 메서드
```python
process_frame(
    frame,                  # 입력 프레임 (BGR)
    show_skeleton=True      # 스켈레톤 표시
)
```

### 옷 크기 조정
```python
shoulder_width * 1.2   # 어깨보다 20% 크게
body_height * 1.5      # 상체 높이의 1.5배
```

### 오버레이 위치
```python
cloth_position = (
    shoulder_center_x,      # X: 어깨 중심
    shoulder_center_y - 20  # Y: 어깨보다 20px 위
)
```

---

## 🚀 프론트엔드 구현 예시

```javascript
// 비디오 캡처
const canvas = document.createElement('canvas');
canvas.width = video.videoWidth;
canvas.height = video.videoHeight;
const ctx = canvas.getContext('2d');
ctx.drawImage(video, 0, 0);

// Base64로 변환
const frameData = canvas.toDataURL('image/jpeg', 0.8);

// 서버로 전송
const response = await fetch('/api/fit/stream', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        frame: frameData,
        showSkeleton: true
    })
});

const result = await response.json();

// 처리된 이미지 표시
video.src = result.frame;
```

---

## 🔍 MediaPipe 랜드마크

사용되는 주요 랜드마크:
- **LEFT_SHOULDER** (11): 왼쪽 어깨
- **RIGHT_SHOULDER** (12): 오른쪽 어깨
- **LEFT_HIP** (23): 왼쪽 골반
- **RIGHT_HIP** (24): 오른쪽 골반

계산:
```python
shoulder_center = (left_shoulder + right_shoulder) / 2
shoulder_width = abs(right_shoulder.x - left_shoulder.x)
body_height = abs(hip_center.y - shoulder_center.y)
```

---

## ⚙️ 성능 최적화

1. **모델 복잡도**: `model_complexity=1` (실시간용)
2. **JPEG 품질**: `85%` (속도와 품질 균형)
3. **싱글톤 패턴**: VirtualFitting 인스턴스 재사용
4. **좌우 반전**: 거울 효과 (`cv2.flip(frame, 1)`)

---

## 🐛 문제 해결

### 1. rembg 설치 오류
```powershell
pip install --upgrade pip
pip install rembg
```

### 2. 옷이 너무 작게/크게 나옴
`virtual_fitting.py`에서 조정:
```python
shoulder_width * 1.2  # 이 값 조정 (1.0 ~ 1.5)
body_height * 1.5     # 이 값 조정 (1.2 ~ 2.0)
```

### 3. 옷 위치가 안 맞음
`virtual_fitting.py`에서 조정:
```python
shoulder_center_y - 20  # 이 값 조정 (-50 ~ 50)
```

### 4. 배경 제거 실패
- 옷 이미지 배경을 단색으로 변경
- 또는 배경 제거 없이 사용 (투명도 낮춤)

---

## 📊 다음 단계 (선택적 개선)

1. **WebSocket**: HTTP 대신 WebSocket으로 지연 시간 감소
2. **GPU 가속**: CUDA 활성화로 처리 속도 향상
3. **여러 옷**: 옷 종류별로 다른 위치/크기 적용
4. **자동 조정**: AI로 옷 크기/위치 자동 최적화
5. **그림자 효과**: 더 사실적인 합성

---

## ✅ 테스트 체크리스트

- [ ] `pip install rembg mediapipe opencv-python pillow` 설치 완료
- [ ] `input/cloth.jpg` 파일 존재 확인
- [ ] `python virtual_fitting.py` 독립 실행 테스트
- [ ] 백엔드 서버 재시작
- [ ] 프론트엔드에서 `/api/fit/stream` 호출 테스트
- [ ] 실시간 비디오에 옷이 오버레이되는지 확인

---

## 📝 참고사항

- **처음 실행 시**: rembg가 AI 모델을 자동 다운로드 (1-2분 소요)
- **옷 이미지**: 정면에서 촬영된 옷 이미지가 가장 잘 작동
- **조명**: 밝은 환경에서 포즈 감지 정확도 향상
- **거리**: 카메라에서 1-2미터 거리 권장
